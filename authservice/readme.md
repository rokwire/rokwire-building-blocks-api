# Authentication Building Block

The present goal of the Authentication Building Block is to provide a set of RESTFul web services to manage phone number verification using Twilio and provide a JSON Web Token (JWT) to protect all future communications betweeen the guest user (user who has logged in using phone number verification) of the mobile app and the Rokwire platform.

## Usage
### Step 1 - Initiate phone number verification

Step 1 of 2 for phone number verification. Initiates the verification with a text or call that contains a code. That code should then be provided to the /authentication/phone-verify endpoint. Note: The phoneNumber property must include a prefix plus symbol (+), the country code (e.g., 1 for USA), and the area code.

#### Example

    curl -d '{
               "phoneNumber": "+12175557890",
               "channel": "sms"
    }' -H "Content-Type: application/json" -X POST https://api-dev.rokwire.illinois.edu/authentication/phone-initiate

### Step 2 - Complete phone number verification

Step 2 of 2 for phone number verification. The request body should contain the code that was sent to the end user as a result of the /authentication/phone-initiate endpoint. phone-verify will check if the code matches what was originally sent to the user. Note: The phoneNumber property must include a prefix plus symbol (+), the country code (e.g., 1 for USA), and the area code.

#### Example

    curl -d '{
               "phoneNumber": "+12175557890",
               "code": "974010"
    }' -H "Content-Type: application/json" -X POST https://api-dev.rokwire.illinois.edu/authentication/phone-verify

## Running the Building Block

### Configuration
Please set up the following environment variables in the terminal (when running as Python Flask Application) or in `.env` file (when running as a Docker container):

#### Twilio API Credentials
These credentials can be obtained by logging into Twilio account and visiting https://www.twilio.com/console.
 - `TWILIO_ACCT_SID`: This is the unique ID of the Twilio account. It is of the format `ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`.
 - `TWILIO_AUTH_TOKEN`: Twilio account auth token.

#### Twilio Veriification Service SID
This ID can be obtained by logging into Twilio account and visiting https://www.twilio.com/console/verify/services.
 - `TWILIO_VERIFY_SERVICE_ID`: Unique ID of the verification service that is created within Twilio account to verify a phone number. It is of the format `VAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX`.
 
#### Authentication Building Block Secrets
These secrets are set up to validate the incoming requests from the mobile app.
 - `PHONE_VERIFY_AUDIENCE`: The unique identifier of the audience for an issued token, identified within a JSON Web Token as the `aud` claim. Here the audience value is the mobile application `Client ID`. Please refer to https://openid.net/specs/openid-connect-core-1_0.html#IDToken and https://auth0.com/docs/glossary#A for more details.
 - `PHONE_VERIFY_SECRET`: Secret key that will be used to encode the ID Tokens generated by the Authentication Building Block.

### Run as a Standalone Python Flask Application
```
$ python auth_rest_service.py
```
### Run as a Docker Container

#### Docker Compose

You need to have Docker installed in your computer.

##### Run command

```
$ docker-compose up
```

##### Docker Compose environment variable configuration

To run locally with Docker Compose, you will need to create a file called `.env`.  See [here](https://docs.docker.com/compose/environment-variables/#the-env-file) for documentation on `.env` files.  Here are the environment variables that need to be defined:

- `TWILIO_ACCT_SID`
- `TWILIO_AUTH_TOKEN`
- `TWILIO_VERIFY_SERVICE_ID`
- `PHONE_VERIFY_SECRET`
- `PHONE_VERIFY_AUDIENCE`
- `ROKWIRE_API_KEY`


## Deployment notes

more instructions can be found [here](https://opensource.ncsa.illinois.edu/confluence/pages/viewpage.action?pageId=147917580)

### Build Docker image and push to Rokwire's Amazon Web Service Elastic Container Registry

- `$ docker-compose build` or maybe `$ docker-compose build --no-cache --force-rm`
- `$ docker tag rokwire/authentication-building-block 779619664536.dkr.ecr.us-east-2.amazonaws.com/rokwire/authservice_web`
- `$ docker push 779619664536.dkr.ecr.us-east-2.amazonaws.com/rokwire/authservice_web`
- If you receive this message, `denied: Your Authorization Token has expired. Please run 'aws ecr get-login --no-include-email' to fetch a new one.`
    - `$ $(aws ecr get-login --no-include-email --region us-east-2)`
